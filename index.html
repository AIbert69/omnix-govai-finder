<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Omnix | GovAI — SAM.gov Finder (Hosted)</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 0; background: #0b0f14; color: #e6edf3; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 32px; }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p.muted { color: #9aa7b2; margin: 4px 0 24px; }
    .card { background: #111826; border: 1px solid #1f2937; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    label { display: block; font-size: 12px; color: #9aa7b2; margin: 10px 0 4px; }
    input, select, button, textarea {
      background: #0f172a; color: #e6edf3; border: 1px solid #334155; border-radius: 8px; padding: 10px;
      width: 100%; box-sizing: border-box; outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: #64748b; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button.primary { background: #2563eb; border-color: #1d4ed8; cursor: pointer; }
    button.secondary { background: #0f172a; border-color: #334155; cursor: pointer; }
    button.ghost { background: transparent; border-color: #1f2937; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border-bottom: 1px solid #1f2937; padding: 10px; text-align: left; vertical-align: top; }
    th { color: #93a4b1; font-weight: 600; font-size: 12px; text-transform: uppercase; }
    a { color: #93c5fd; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .pill { font-size: 12px; padding: 2px 8px; border: 1px solid #334155; border-radius: 999px; background:#0f172a; display:inline-block; }
    nav a { margin-right: 12px; color:#9aa7b2; text-decoration:none; }
    nav a:hover { color:#e6edf3; }
    .small { font-size:12px; color:#9aa7b2 }
    .kbd { border:1px solid #334155; border-bottom-width:2px; padding:0 6px; border-radius:6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a href="./index.html">Finder</a>
      <a href="./codes.html">Singh Codes</a>
      <a href="./key.html">API Key (masked)</a>
    </nav>
    <h1>Omnix | GovAI — SAM.gov Finder (Hosted)</h1>
    <p class="muted">Search SAM.gov via your own serverless proxy (no CORS). Your API key stays on the server.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Keywords</label>
          <input id="kw" placeholder='robotics OR automation OR "control systems" OR unmanned OR AI' />
        </div>
        <div>
          <label>NAICS (comma-separated) <span class="small">Tip: click <span class="kbd">Fill Singh</span> below</span></label>
          <input id="naics" placeholder="336992,541715,541512,541330" />
          <div class="actions" style="margin-top:8px">
            <button class="ghost" id="fillSingh">Fill Singh NAICS</button>
            <button class="ghost" id="clearNaics">Clear</button>
          </div>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Days back</label>
          <input id="days" type="number" min="1" max="365" value="90" />
        </div>
        <div>
          <label>Limit (per page)</label>
          <input id="limit" type="number" min="1" max="200" value="100" />
        </div>
        <div>
          <label>Min ceiling ($)</label>
          <input id="minCeiling" type="number" value="0" />
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="btnSearch">Search SAM.gov</button>
        <button class="secondary" id="btnExportCsv">Export CSV</button>
        <span id="status" class="pill"></span>
      </div>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Agency</th>
            <th>Posted</th>
            <th>Deadline</th>
            <th>NAICS</th>
            <th>Set-Aside</th>
            <th>Value</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SINGH_NAICS = ["333249", "333318", "333517", "333613", "333921", "333922", "333923", "334118", "334290", "334511", "334512", "334513", "334519", "336413", "336414", "336415", "336992", "541330", "541380", "541420", "541511", "541512", "541513", "541519", "541611", "541614", "541690", "541715", "561210", "811310"];
    const rowsEl = document.getElementById('rows');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('btnSearch');
    const btnCsv = document.getElementById('btnExportCsv');
    const fillSingh = document.getElementById('fillSingh');
    const clearNaics = document.getElementById('clearNaics');
    const naicsInput = document.getElementById('naics');

    function setStatus(text) { statusEl.textContent = text || ""; }

    function csvEscape(s) {
      if (s == null) return "";
      s = String(s);
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
    }

    function toCSV(items) {
      const headers = ["title","agency","posted","deadline","naics","setAside","value","uiLink","noticeType","solicitationNumber"];
      const lines = [headers.join(",")];
      for (const r of items) {
        lines.push(headers.map(h => csvEscape(r[h])).join(","));
      }
      return lines.join("\\n");
    }

    fillSingh.addEventListener('click', ()=>{
      naicsInput.value = SINGH_NAICS.join(',');
    });
    clearNaics.addEventListener('click', ()=>{
      naicsInput.value = '';
    });

    btnCsv.addEventListener('click', () => {
      const trs = rowsEl.querySelectorAll('tr');
      if (!trs.length) { alert('No data to export'); return; }
      const data = Array.from(trs).map(tr => {
        const tds = tr.querySelectorAll('td');
        return {
          title: tds[0].innerText,
          agency: tds[1].innerText,
          posted: tds[2].innerText,
          deadline: tds[3].innerText,
          naics: tds[4].innerText,
          setAside: tds[5].innerText,
          value: tds[6].innerText,
          uiLink: tds[7].querySelector('a')?.href || "",
          noticeType: tds[7].dataset.notice || "",
          solicitationNumber: tds[7].dataset.sol || ""
        };
      });
      const blob = new Blob([toCSV(data)], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'samgov_results.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    btn.addEventListener('click', async () => {
      setStatus('Searching...');
      rowsEl.innerHTML = '';
      try {
        const payload = {
          keyword: document.getElementById('kw').value || 'robotics OR automation OR "control systems" OR unmanned OR AI',
          naics: (document.getElementById('naics').value || '').split(',').map(s => s.trim()).filter(Boolean),
          days: Number(document.getElementById('days').value || 90),
          limit: Number(document.getElementById('limit').value || 100),
          minCeiling: Number(document.getElementById('minCeiling').value || 0)
        };

        const r = await fetch('/api/samgov', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        const items = (data && data.results) || [];

        if (!items.length) {
          rowsEl.innerHTML = '<tr><td colspan="8" style="color:#9aa7b2">No results for this query.</td></tr>';
          setStatus('0 found');
          return;
        }

        const frag = document.createDocumentFragment();
        items.forEach(it => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.title || '-'}</td>
            <td>${it.agency || '-'}</td>
            <td>${it.posted || '-'}</td>
            <td>${it.deadline || '-'}</td>
            <td>${it.naics || '-'}</td>
            <td>${it.setAside || '-'}</td>
            <td>${it.value || '-'}</td>
            <td data-notice="${(it.noticeType||'').replace(/"/g,'&quot;')}" data-sol="${(it.solicitationNumber||'').replace(/"/g,'&quot;')}">
              ${it.uiLink ? `<a target="_blank" rel="noopener" href="${it.uiLink}">View</a>` : '-'}
            </td>`;
          frag.appendChild(tr);
        });
        rowsEl.appendChild(frag);
        setStatus(items.length + ' found');

      } catch (err) {
        console.error(err);
        setStatus('Error');
        rowsEl.innerHTML = '<tr><td colspan="8" style="color:#ef4444">Request failed. Check server logs & API key.</td></tr>';
      }
    });
  </script>
</body>
</html>
